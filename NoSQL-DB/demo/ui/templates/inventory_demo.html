{% extends "base.html" %}

{% block title %}Inventory Management Demo - Distributed Database{% endblock %}
{% block demo_type %}inventory{% endblock %}

{% block header_title %}📦 E-commerce Inventory Management{% endblock %}
{% block header_subtitle %}Multi-warehouse synchronization with anti-entropy protocols{% endblock %}

{% block content %}
<!-- Product Selection -->
<div class="card">
    <h3>📱 Select Product to Monitor</h3>
    <div class="form-group">
        <label class="form-label">Product</label>
        <select class="form-input" id="productSelect">
            <option value="iphone-14-pro">📱 iPhone 14 Pro (128GB)</option>
            <option value="macbook-pro">💻 MacBook Pro M2</option>
            <option value="airpods-pro">🎧 AirPods Pro</option>
            <option value="ipad-air">📱 iPad Air</option>
            <option value="apple-watch">⌚ Apple Watch Series 8</option>
        </select>
    </div>
    <button class="btn btn-primary" onclick="initializeProduct()">🔍 Monitor Product</button>
</div>

<!-- Warehouse Inventory Status -->
<div class="card" id="warehouseCard" style="display: none;">
    <h3>🏭 Warehouse Inventory Status <span class="live-indicator">LIVE</span></h3>
    <div class="node-grid" id="warehouseGrid">
        <!-- Warehouse status will be displayed here -->
    </div>
</div>

<!-- Anti-Entropy Status -->
<div class="card" id="antiEntropyCard" style="display: none;">
    <h3>🔄 Anti-Entropy Synchronization</h3>
    <div id="syncStatus" style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 15px; border-radius: 8px;">
            <div>
                <div style="font-weight: 600;">Sync Status</div>
                <div style="font-size: 14px; color: #6b7280;" id="syncStatusText">All warehouses synchronized</div>
            </div>
            <div class="status status-healthy" id="syncIndicator">✅ SYNCED</div>
        </div>
    </div>
    
    <!-- Merkle Tree Visualization -->
    <div id="merkleTreeViz">
        <h4>🌳 Merkle Tree Comparison</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;" id="merkleContainer">
            <!-- Merkle trees will be displayed here -->
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="card" id="transactionsCard" style="display: none;">
    <h3>📋 Recent Transactions</h3>
    <div id="transactionsList">
        <!-- Transaction history will be displayed here -->
    </div>
</div>

<!-- Inventory Operations -->
<div class="card" id="operationsCard" style="display: none;">
    <h3>📊 Inventory Operations</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="text-align: center;">
            <button class="btn btn-secondary" onclick="processOrder()" style="width: 100%; margin-bottom: 10px;">
                📦 Process Order (-5 units)
            </button>
            <div style="font-size: 12px; color: #6b7280;">Customer purchase</div>
        </div>
        <div style="text-align: center;">
            <button class="btn btn-secondary" onclick="receiveShipment()" style="width: 100%; margin-bottom: 10px;">
                🚚 Receive Shipment (+50 units)
            </button>
            <div style="font-size: 12px; color: #6b7280;">New stock arrival</div>
        </div>
        <div style="text-align: center;">
            <button class="btn btn-secondary" onclick="transferStock()" style="width: 100%; margin-bottom: 10px;">
                🔄 Transfer Stock
            </button>
            <div style="font-size: 12px; color: #6b7280;">Between warehouses</div>
        </div>
        <div style="text-align: center;">
            <button class="btn btn-warning" onclick="adjustInventory()" style="width: 100%; margin-bottom: 10px;">
                ⚙️ Inventory Adjustment
            </button>
            <div style="font-size: 12px; color: #6b7280;">Manual correction</div>
        </div>
    </div>
</div>

<!-- Demo Controls -->
<div class="card">
    <h3>🎮 Demo Controls</h3>
    <div style="text-align: center;">
        <button class="btn btn-primary" onclick="simulateHighTraffic()" style="margin: 5px;">
            🔥 Simulate Black Friday
        </button>
        <button class="btn btn-warning" onclick="createInconsistency()" style="margin: 5px;">
            ⚠️ Create Inconsistency
        </button>
        <button class="btn btn-secondary" onclick="triggerAntiEntropy()" style="margin: 5px;">
            🔄 Trigger Sync
        </button>
        <button class="btn btn-danger" onclick="resetInventory()" style="margin: 5px;">
            🔄 Reset Demo
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentProduct = null;
    let warehouseData = {};
    let transactionHistory = [];
    let updateInterval = null;
    let inconsistencyDetected = false;
    
    const productInfo = {
        'iphone-14-pro': { name: 'iPhone 14 Pro (128GB)', price: 999, sku: 'APL-IP14P-128' },
        'macbook-pro': { name: 'MacBook Pro M2', price: 1999, sku: 'APL-MBP-M2' },
        'airpods-pro': { name: 'AirPods Pro', price: 249, sku: 'APL-APP-2GEN' },
        'ipad-air': { name: 'iPad Air', price: 599, sku: 'APL-IPA-5GEN' },
        'apple-watch': { name: 'Apple Watch Series 8', price: 399, sku: 'APL-AWS-8' }
    };
    
    const warehouses = [
        { id: 'ny-warehouse', name: 'New York Warehouse', location: 'New York, NY', color: '#3b82f6' },
        { id: 'la-warehouse', name: 'Los Angeles Warehouse', location: 'Los Angeles, CA', color: '#10b981' },
        { id: 'chicago-warehouse', name: 'Chicago Warehouse', location: 'Chicago, IL', color: '#f59e0b' }
    ];
    
    function initializeProduct() {
        const productId = document.getElementById('productSelect').value;
        currentProduct = productInfo[productId];
        
        // Initialize warehouse data
        warehouseData = {};
        warehouses.forEach(warehouse => {
            warehouseData[warehouse.id] = {
                ...warehouse,
                stock: Math.floor(Math.random() * 500) + 200, // 200-700 initial stock
                lastUpdate: Date.now(),
                merkleRoot: generateMerkleRoot(),
                status: 'healthy'
            };
        });
        
        transactionHistory = [];
        showInventoryCards();
        updateWarehouseDisplay();
        startRealTimeUpdates();
        
        showMessage(`📱 Now monitoring ${currentProduct.name} across all warehouses`, 'success');
    }
    
    function showInventoryCards() {
        document.getElementById('warehouseCard').style.display = 'block';
        document.getElementById('antiEntropyCard').style.display = 'block';
        document.getElementById('transactionsCard').style.display = 'block';
        document.getElementById('operationsCard').style.display = 'block';
    }
    
    function updateWarehouseDisplay() {
        const container = document.getElementById('warehouseGrid');
        container.innerHTML = '';
        
        warehouses.forEach(warehouse => {
            const data = warehouseData[warehouse.id];
            const warehouseDiv = document.createElement('div');
            warehouseDiv.className = `node-card ${data.status !== 'healthy' ? 'syncing' : ''}`;
            
            const stockLevel = data.stock;
            const stockStatus = stockLevel > 100 ? 'healthy' : stockLevel > 50 ? 'warning' : 'critical';
            const stockColor = stockStatus === 'healthy' ? '#22c55e' : 
                              stockStatus === 'warning' ? '#f59e0b' : '#ef4444';
            
            warehouseDiv.innerHTML = `
                <h4 style="color: ${data.color};">🏭 ${data.name}</h4>
                <div style="color: #6b7280; font-size: 12px; margin-bottom: 15px;">${data.location}</div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 24px; font-weight: 800; color: ${stockColor}; text-align: center;">
                        ${stockLevel}
                    </div>
                    <div style="text-align: center; font-size: 12px; color: #6b7280;">
                        units in stock
                    </div>
                </div>
                
                <div style="font-size: 12px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Last Update:</span>
                        <span>${timeAgo(data.lastUpdate / 1000)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Merkle Root:</span>
                        <span style="font-family: monospace;">${data.merkleRoot.substring(0, 8)}...</span>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <span class="status status-${stockStatus}">${stockStatus.toUpperCase()}</span>
                </div>
                
                ${data.status !== 'healthy' ? '<div style="margin-top: 8px; font-size: 12px; color: #f59e0b; text-align: center;">⏳ Syncing...</div>' : ''}
            `;
            
            container.appendChild(warehouseDiv);
        });
        
        updateAntiEntropyStatus();
        updateMerkleTreeVisualization();
    }
    
    function updateAntiEntropyStatus() {
        const merkleRoots = Object.values(warehouseData).map(w => w.merkleRoot);
        const allSynced = merkleRoots.every(root => root === merkleRoots[0]);
        
        const statusText = document.getElementById('syncStatusText');
        const indicator = document.getElementById('syncIndicator');
        
        if (allSynced && !inconsistencyDetected) {
            statusText.textContent = 'All warehouses synchronized';
            indicator.className = 'status status-healthy';
            indicator.textContent = '✅ SYNCED';
        } else {
            statusText.textContent = 'Inconsistency detected - anti-entropy in progress';
            indicator.className = 'status status-degraded';
            indicator.textContent = '⚠️ SYNCING';
        }
    }
    
    function updateMerkleTreeVisualization() {
        const container = document.getElementById('merkleContainer');
        container.innerHTML = '';
        
        warehouses.forEach(warehouse => {
            const data = warehouseData[warehouse.id];
            const treeDiv = document.createElement('div');
            treeDiv.style.cssText = 'background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px;';
            
            const isConsistent = Object.values(warehouseData).every(w => w.merkleRoot === data.merkleRoot);
            const borderColor = isConsistent ? '#22c55e' : '#f59e0b';
            treeDiv.style.borderLeft = `4px solid ${borderColor}`;
            
            treeDiv.innerHTML = `
                <h5 style="margin-bottom: 10px; color: ${data.color};">${warehouse.name}</h5>
                <div style="font-family: monospace; font-size: 11px; margin-bottom: 8px;">
                    <div style="text-align: center; font-weight: bold; color: ${borderColor};">
                        ${data.merkleRoot}
                    </div>
                </div>
                <div style="font-family: monospace; font-size: 10px; color: #6b7280;">
                    <div style="text-align: center;">├─ inventory: ${data.stock}</div>
                    <div style="text-align: center;">├─ timestamp: ${data.lastUpdate}</div>
                    <div style="text-align: center;">└─ checksum: ${(data.stock * 13 + data.lastUpdate % 1000).toString(16)}</div>
                </div>
                <div style="text-align: center; margin-top: 8px;">
                    <span style="font-size: 10px; color: ${borderColor};">
                        ${isConsistent ? '✅ CONSISTENT' : '⚠️ DIFFERS'}
                    </span>
                </div>
            `;
            
            container.appendChild(treeDiv);
        });
    }
    
    function addTransaction(type, warehouse, change, details) {
        const transaction = {
            id: Date.now(),
            type: type,
            warehouse: warehouse,
            change: change,
            details: details,
            timestamp: Date.now(),
            productSku: currentProduct.sku
        };
        
        transactionHistory.unshift(transaction);
        if (transactionHistory.length > 10) {
            transactionHistory.pop();
        }
        
        updateTransactionsList();
    }
    
    function updateTransactionsList() {
        const container = document.getElementById('transactionsList');
        container.innerHTML = '';
        
        if (transactionHistory.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">No recent transactions</div>';
            return;
        }
        
        transactionHistory.forEach(transaction => {
            const warehouseInfo = warehouses.find(w => w.id === transaction.warehouse);
            const typeIcon = {
                'order': '📦',
                'shipment': '🚚',
                'transfer': '🔄',
                'adjustment': '⚙️'
            }[transaction.type] || '📋';
            
            const changeColor = transaction.change > 0 ? '#22c55e' : '#ef4444';
            const changeText = transaction.change > 0 ? `+${transaction.change}` : transaction.change;
            
            const transactionDiv = document.createElement('div');
            transactionDiv.style.cssText = 'border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; background: white;';
            
            transactionDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: #1f2937;">
                            ${typeIcon} ${transaction.details}
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
                            ${warehouseInfo?.name} • ${timeAgo(transaction.timestamp / 1000)}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: ${changeColor};">
                            ${changeText} units
                        </div>
                        <div style="font-size: 11px; color: #6b7280;">
                            SKU: ${transaction.productSku}
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(transactionDiv);
        });
    }
    
    function processOrder() {
        if (!currentProduct) {
            showMessage('Please select a product first!', 'error');
            return;
        }
        
        // Randomly select a warehouse for the order
        const warehouseId = warehouses[Math.floor(Math.random() * warehouses.length)].id;
        const warehouse = warehouseData[warehouseId];
        
        if (warehouse.stock < 5) {
            showMessage('❌ Insufficient stock for order!', 'error');
            return;
        }
        
        warehouse.stock -= 5;
        warehouse.lastUpdate = Date.now();
        warehouse.merkleRoot = generateMerkleRoot();
        
        addTransaction('order', warehouseId, -5, `Customer order #${Math.floor(Math.random() * 10000)}`);
        updateWarehouseDisplay();
        
        showMessage(`📦 Order processed! 5 units shipped from ${warehouse.name}`, 'success');
    }
    
    function receiveShipment() {
        if (!currentProduct) {
            showMessage('Please select a product first!', 'error');
            return;
        }
        
        // Randomly select a warehouse for the shipment
        const warehouseId = warehouses[Math.floor(Math.random() * warehouses.length)].id;
        const warehouse = warehouseData[warehouseId];
        
        warehouse.stock += 50;
        warehouse.lastUpdate = Date.now();
        warehouse.merkleRoot = generateMerkleRoot();
        
        addTransaction('shipment', warehouseId, 50, `Supplier shipment #${Math.floor(Math.random() * 1000)}`);
        updateWarehouseDisplay();
        
        showMessage(`🚚 Shipment received! 50 units added to ${warehouse.name}`, 'success');
    }
    
    function transferStock() {
        if (!currentProduct) {
            showMessage('Please select a product first!', 'error');
            return;
        }
        
        const fromId = warehouses[0].id;
        const toId = warehouses[1].id;
        const fromWarehouse = warehouseData[fromId];
        const toWarehouse = warehouseData[toId];
        
        if (fromWarehouse.stock < 20) {
            showMessage('❌ Insufficient stock for transfer!', 'error');
            return;
        }
        
        fromWarehouse.stock -= 20;
        toWarehouse.stock += 20;
        
        fromWarehouse.lastUpdate = Date.now();
        toWarehouse.lastUpdate = Date.now();
        fromWarehouse.merkleRoot = generateMerkleRoot();
        toWarehouse.merkleRoot = generateMerkleRoot();
        
        addTransaction('transfer', fromId, -20, `Transfer to ${toWarehouse.name}`);
        addTransaction('transfer', toId, 20, `Transfer from ${fromWarehouse.name}`);
        updateWarehouseDisplay();
        
        showMessage(`🔄 Stock transferred! 20 units moved from ${fromWarehouse.name} to ${toWarehouse.name}`, 'success');
    }
    
    function adjustInventory() {
        if (!currentProduct) {
            showMessage('Please select a product first!', 'error');
            return;
        }
        
        const warehouseId = warehouses[2].id;
        const warehouse = warehouseData[warehouseId];
        const adjustment = Math.floor(Math.random() * 21) - 10; // -10 to +10
        
        warehouse.stock += adjustment;
        warehouse.lastUpdate = Date.now();
        warehouse.merkleRoot = generateMerkleRoot();
        
        addTransaction('adjustment', warehouseId, adjustment, 'Inventory reconciliation');
        updateWarehouseDisplay();
        
        const adjustmentText = adjustment > 0 ? `+${adjustment}` : adjustment;
        showMessage(`⚙️ Inventory adjusted! ${adjustmentText} units at ${warehouse.name}`, 'info');
    }
    
    function simulateHighTraffic() {
        showMessage('🔥 Simulating Black Friday traffic...', 'info');
        
        let orderCount = 0;
        const maxOrders = 20;
        
        const orderInterval = setInterval(() => {
            processOrder();
            orderCount++;
            
            if (orderCount >= maxOrders) {
                clearInterval(orderInterval);
                showMessage('✅ Black Friday simulation complete! High traffic handled successfully.', 'success');
            }
        }, 500);
    }
    
    function createInconsistency() {
        showMessage('⚠️ Creating inconsistency scenario...', 'warning');
        inconsistencyDetected = true;
        
        // Artificially create different merkle roots
        warehouses.forEach((warehouse, index) => {
            const data = warehouseData[warehouse.id];
            data.merkleRoot = generateMerkleRoot() + '_' + index;
            data.status = index === 1 ? 'syncing' : 'healthy';
        });
        
        updateWarehouseDisplay();
        
        setTimeout(() => {
            showMessage('🔍 Inconsistency detected! Anti-entropy will resolve...', 'warning');
            
            setTimeout(() => {
                triggerAntiEntropy();
            }, 3000);
        }, 1000);
    }
    
    function triggerAntiEntropy() {
        showMessage('🔄 Triggering anti-entropy synchronization...', 'info');
        
        // Simulate sync process
        warehouses.forEach(warehouse => {
            warehouseData[warehouse.id].status = 'syncing';
        });
        
        updateWarehouseDisplay();
        
        setTimeout(() => {
            // Resolve inconsistency
            const baseRoot = generateMerkleRoot();
            warehouses.forEach(warehouse => {
                const data = warehouseData[warehouse.id];
                data.merkleRoot = baseRoot;
                data.status = 'healthy';
                data.lastUpdate = Date.now();
            });
            
            inconsistencyDetected = false;
            updateWarehouseDisplay();
            showMessage('✅ Anti-entropy sync complete! All warehouses consistent.', 'success');
        }, 3000);
    }
    
    function resetInventory() {
        if (confirm('Reset the inventory demo? This will clear all data.')) {
            currentProduct = null;
            warehouseData = {};
            transactionHistory = [];
            inconsistencyDetected = false;
            
            if (updateInterval) clearInterval(updateInterval);
            
            document.getElementById('warehouseCard').style.display = 'none';
            document.getElementById('antiEntropyCard').style.display = 'none';
            document.getElementById('transactionsCard').style.display = 'none';
            document.getElementById('operationsCard').style.display = 'none';
            
            showMessage('Inventory demo reset! 🔄', 'success');
        }
    }
    
    function generateMerkleRoot() {
        return Math.random().toString(16).substring(2, 18);
    }
    
    function startRealTimeUpdates() {
        if (updateInterval) clearInterval(updateInterval);
        
        updateInterval = setInterval(() => {
            if (currentProduct) {
                // Simulate minor stock fluctuations
                if (Math.random() < 0.1) { // 10% chance per interval
                    const warehouseId = warehouses[Math.floor(Math.random() * warehouses.length)].id;
                    const warehouse = warehouseData[warehouseId];
                    const change = Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
                    
                    if (change !== 0 && warehouse.stock + change > 0) {
                        warehouse.stock += change;
                        warehouse.lastUpdate = Date.now();
                        warehouse.merkleRoot = generateMerkleRoot();
                        
                        const reason = change > 0 ? 'Automatic restock' : 'System correction';
                        addTransaction('adjustment', warehouseId, change, reason);
                        updateWarehouseDisplay();
                    }
                }
            }
        }, 5000);
    }
    
    // Initialize demo
    document.addEventListener('DOMContentLoaded', function() {
        console.log('📦 Inventory demo initialized');
    });
</script>

<style>
.node-card.syncing {
    border-left-color: #f59e0b;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}
</style>
{% endblock %}