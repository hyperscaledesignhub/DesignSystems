{% extends "base.html" %}

{% block title %}Collaborative Editor Demo - Distributed Database{% endblock %}
{% block demo_type %}collab_editor{% endblock %}

{% block header_title %}üìù Live Collaborative Document Editor{% endblock %}
{% block header_subtitle %}Watch Alice and Bob edit in real-time with causal consistency{% endblock %}

{% block content %}
<!-- Live Demo Document -->
<div class="card">
    <h3>üöÄ Live Collaborative Demo <span class="live-indicator" style="animation: pulse 1s infinite;">LIVE</span></h3>
    
    <!-- Active Users -->
    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
        <span style="font-weight: 600;">Active Editors:</span>
        <div id="aliceStatus" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: {{ user_alice.color }}20; border-radius: 20px; border: 2px solid {{ user_alice.color }};">
            <span style="font-size: 20px;">{{ user_alice.avatar }}</span>
            <span style="font-weight: 600; color: {{ user_alice.color }};">{{ user_alice.name }}</span>
            <span id="aliceTyping" style="display: none; font-size: 12px;">typing...</span>
        </div>
        <div id="bobStatus" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: {{ user_bob.color }}20; border-radius: 20px; border: 2px solid {{ user_bob.color }};">
            <span style="font-size: 20px;">{{ user_bob.avatar }}</span>
            <span style="font-weight: 600; color: {{ user_bob.color }};">{{ user_bob.name }}</span>
            <span id="bobTyping" style="display: none; font-size: 12px;">typing...</span>
        </div>
    </div>
    
    <!-- Document Display -->
    <div id="documentDisplay" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 30px; margin-bottom: 20px; min-height: 400px;">
        <h2 id="documentTitle" style="margin-bottom: 30px; color: #1f2937; font-size: 24px;">{{ demo_document_id or 'Initializing...' }}</h2>
        
        <div id="paragraphsContainer">
            <!-- Document sections will be populated here -->
            <div id="intro" class="paragraph-section" style="margin-bottom: 25px;">
                <h4 style="color: #374151; margin-bottom: 10px;">Introduction</h4>
                <div class="paragraph-content" style="line-height: 1.8; font-size: 16px; color: #4b5563; padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #e5e7eb;">
                    <span class="text-content">Waiting for editors to start...</span>
                    <span class="author-tag" style="font-size: 12px; color: #9ca3af; margin-left: 10px;"></span>
                </div>
            </div>
            
            <div id="section1" class="paragraph-section" style="margin-bottom: 25px;">
                <h4 style="color: #374151; margin-bottom: 10px;">Section 1: Alice's Primary Section</h4>
                <div class="paragraph-content" style="line-height: 1.8; font-size: 16px; color: #4b5563; padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid {{ user_alice.color }};">
                    <span class="text-content">Alice will edit here...</span>
                    <span class="author-tag" style="font-size: 12px; color: {{ user_alice.color }}; margin-left: 10px;"></span>
                </div>
            </div>
            
            <div id="section2" class="paragraph-section" style="margin-bottom: 25px;">
                <h4 style="color: #374151; margin-bottom: 10px;">Section 2: Bob's Primary Section</h4>
                <div class="paragraph-content" style="line-height: 1.8; font-size: 16px; color: #4b5563; padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid {{ user_bob.color }};">
                    <span class="text-content">Bob will edit here...</span>
                    <span class="author-tag" style="font-size: 12px; color: {{ user_bob.color }}; margin-left: 10px;"></span>
                </div>
            </div>
            
            <div id="section3" class="paragraph-section" style="margin-bottom: 25px;">
                <h4 style="color: #374151; margin-bottom: 10px;">Section 3: Alice's Additional Section</h4>
                <div class="paragraph-content" style="line-height: 1.8; font-size: 16px; color: #4b5563; padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid {{ user_alice.color }};">
                    <span class="text-content">More content from Alice...</span>
                    <span class="author-tag" style="font-size: 12px; color: {{ user_alice.color }}; margin-left: 10px;"></span>
                </div>
            </div>
            
            <div id="section4" class="paragraph-section" style="margin-bottom: 25px;">
                <h4 style="color: #374151; margin-bottom: 10px;">Section 4: Bob's Additional Section</h4>
                <div class="paragraph-content" style="line-height: 1.8; font-size: 16px; color: #4b5563; padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid {{ user_bob.color }};">
                    <span class="text-content">More content from Bob...</span>
                    <span class="author-tag" style="font-size: 12px; color: {{ user_bob.color }}; margin-left: 10px;"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Consistency Visualization -->
<div class="card">
    <h3>üîÑ Data Consistency Status</h3>
    <div id="consistencyStatus" style="text-align: center; padding: 20px; background: #f0fdf4; border-radius: 8px; border: 2px solid #22c55e;">
        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
        <h4 style="color: #16a34a; margin-bottom: 10px;">All Nodes Consistent</h4>
        <p style="color: #15803d;">All 3 nodes have identical document content with proper causal ordering</p>
    </div>
    
    <div class="node-grid" id="nodeConsistencyGrid" style="margin-top: 20px;">
        <!-- Node consistency details will be shown here -->
    </div>
</div>

<!-- Vector Clocks Visualization -->
<div class="card">
    <h3>üïê Vector Clocks & Causal Ordering</h3>
    <div id="vectorClockVisualization">
        <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <h4 style="color: #0369a1; margin-bottom: 15px;">üìö How Vector Clocks Resolve Conflicts</h4>
            <div style="margin-bottom: 15px;">
                <p style="color: #1e40af; font-weight: 600; margin-bottom: 8px;">In Our Implementation:</p>
                <ul style="color: #374151; line-height: 1.6; margin-left: 20px;">
                    <li><strong>Read-then-Write Pattern:</strong> Each edit first reads the document to get the current vector clock</li>
                    <li><strong>Causal Endpoints:</strong> We use <code>/causal/kv/</code> endpoints that automatically manage vector clocks</li>
                    <li><strong>Automatic Ordering:</strong> The database ensures edits are applied in causal order using vector clocks</li>
                    <li><strong>Conflict Detection:</strong> Vector clocks help detect when edits happened concurrently vs sequentially</li>
                </ul>
            </div>
            <div style="background: white; border-radius: 6px; padding: 15px; border-left: 4px solid #0ea5e9;">
                <p style="color: #1e40af; font-weight: 600; margin-bottom: 8px;">üîÑ Example Scenario:</p>
                <p style="color: #374151; font-size: 14px; line-height: 1.5;">
                    1. Alice edits "Introduction" ‚Üí Vector Clock: {node1: 5, node2: 3, node3: 2}<br>
                    2. Bob edits "Introduction" ‚Üí Gets Alice's vector clock, increments ‚Üí {node1: 5, node2: 4, node3: 2}<br>
                    3. System ensures Bob's edit appears after Alice's edit in all nodes
                </p>
            </div>
        </div>
        <div class="node-grid" id="vectorClockDisplay">
            <!-- Vector clocks will be displayed here -->
        </div>
    </div>
</div>

<!-- Edit History Timeline -->
<div class="card">
    <h3>üìú Edit History Timeline</h3>
    <div id="editTimeline" style="max-height: 300px; overflow-y: auto;">
        <!-- Edit history will be shown here -->
    </div>
</div>

<!-- Conflict Detection (shown when conflicts occur) -->
<div class="card" id="conflictCard" style="display: none;">
    <h3>‚ö†Ô∏è Concurrent Edit Detected!</h3>
    <div id="conflictDisplay">
        <!-- Conflict details will be shown here -->
    </div>
</div>

<!-- Demo Controls -->
<div class="card">
    <h3>üéÆ Demo Controls</h3>
    <div style="text-align: center;">
        <button class="btn btn-primary" onclick="pauseEditing()" id="pauseBtn" style="margin: 5px;">
            ‚è∏Ô∏è Pause Editing
        </button>
        <button class="btn btn-warning" onclick="simulateConflict()" style="margin: 5px;">
            ‚öîÔ∏è Simulate Conflict
        </button>
        <button class="btn btn-secondary" onclick="showNodeFailure()" style="margin: 5px;">
            üö® Simulate Node Failure
        </button>
        <button class="btn btn-info" onclick="refreshDemo()" style="margin: 5px;">
            üîÑ Refresh Status
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let isPaused = false;
    let editHistory = [];
    let demoDocumentId = '{{ demo_document_id }}';
    
    // Update paragraph content in real-time
    function updateParagraph(paraId, content, author, authorColor) {
        const section = document.getElementById(paraId);
        if (section) {
            const contentSpan = section.querySelector('.text-content');
            const authorTag = section.querySelector('.author-tag');
            const paragraphContent = section.querySelector('.paragraph-content');
            
            contentSpan.textContent = content;
            authorTag.textContent = `‚Äî ${author}`;
            authorTag.style.color = authorColor;
            
            // Update border color to show who's editing
            paragraphContent.style.borderLeftColor = authorColor;
            
            // Add typing animation
            if (author === 'Alice') {
                document.getElementById('aliceTyping').style.display = 'inline';
                setTimeout(() => {
                    document.getElementById('aliceTyping').style.display = 'none';
                }, 1000);
            } else if (author === 'Bob') {
                document.getElementById('bobTyping').style.display = 'inline';
                setTimeout(() => {
                    document.getElementById('bobTyping').style.display = 'none';
                }, 1000);
            }
            
            // Highlight the section briefly
            paragraphContent.style.transition = 'background-color 0.5s';
            paragraphContent.style.backgroundColor = authorColor + '20';
            setTimeout(() => {
                paragraphContent.style.backgroundColor = '#f9fafb';
            }, 500);
        }
    }
    
    // Add to edit history
    function addToEditHistory(author, paraId, content, timestamp, vectorClock) {
        const historyItem = {
            author: author,
            paraId: paraId,
            content: content.substring(0, 50) + '...',
            timestamp: timestamp,
            vectorClock: vectorClock
        };
        
        editHistory.unshift(historyItem);
        if (editHistory.length > 20) editHistory.pop();
        
        updateEditTimeline();
    }
    
    // Update edit timeline display
    function updateEditTimeline() {
        const timeline = document.getElementById('editTimeline');
        timeline.innerHTML = editHistory.map(item => `
            <div style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-weight: 600; color: ${item.author === 'Alice' ? '{{ user_alice.color }}' : '{{ user_bob.color }}'};">
                            ${item.author}
                        </span>
                        <span style="color: #6b7280; font-size: 12px; margin-left: 10px;">
                            edited ${getParagraphName(item.paraId)}
                        </span>
                    </div>
                    <span style="font-size: 12px; color: #9ca3af;">
                        ${new Date(item.timestamp * 1000).toLocaleTimeString()}
                    </span>
                </div>
                <div style="font-size: 14px; color: #6b7280; margin-top: 5px;">
                    "${item.content}"
                </div>
                <div style="font-size: 10px; font-family: monospace; color: #9ca3af; margin-top: 3px; background: #f8fafc; padding: 4px; border-radius: 3px;">
                    Vector Clock: {${Object.entries(item.vectorClock || {}).map(([k,v]) => `${k}:${v}`).join(', ') || 'updating...'}}
                </div>
            </div>
        `).join('');
    }
    
    function getParagraphName(paraId) {
        const names = {
            'intro': 'Introduction',
            'section1': 'Section 1',
            'section2': 'Section 2',
            'section3': 'Section 3',
            'section4': 'Section 4'
        };
        return names[paraId] || paraId;
    }
    
    // Load demo document status
    function loadDemoDocument() {
        if (!demoDocumentId) return;
        
        fetch('/api/demo_document')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateConsistencyStatus(data.consistency);
                    updateNodeConsistency(data.nodes);
                    updateVectorClocks(data.vector_clocks);
                }
            })
            .catch(error => {
                console.error('Error loading demo document:', error);
            });
    }
    
    // Update consistency status display
    function updateConsistencyStatus(consistency) {
        const statusDiv = document.getElementById('consistencyStatus');
        
        if (consistency.is_consistent) {
            statusDiv.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                <h4 style="color: #16a34a; margin-bottom: 10px;">All Nodes Consistent</h4>
                <p style="color: #15803d;">${consistency.message}</p>
                <p style="font-size: 14px; color: #15803d; margin-top: 10px;">
                    All nodes at version ${consistency.versions[0]}
                </p>
            `;
            statusDiv.style.background = '#f0fdf4';
            statusDiv.style.borderColor = '#22c55e';
        } else {
            statusDiv.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 10px;">‚è≥</div>
                <h4 style="color: #ca8a04; margin-bottom: 10px;">Converging to Consistency</h4>
                <p style="color: #a16207;">${consistency.message}</p>
                <p style="font-size: 14px; color: #a16207; margin-top: 10px;">
                    ${consistency.unique_content_versions} different versions detected
                </p>
            `;
            statusDiv.style.background = '#fefce8';
            statusDiv.style.borderColor = '#facc15';
        }
    }
    
    // Update node consistency grid
    function updateNodeConsistency(nodes) {
        const grid = document.getElementById('nodeConsistencyGrid');
        grid.innerHTML = '';
        
        Object.entries(nodes).forEach(([nodeId, nodeData]) => {
            const nodeCard = document.createElement('div');
            nodeCard.className = 'node-card';
            
            if (nodeData.status === 'healthy' && nodeData.document) {
                const doc = nodeData.document;
                const paragraphCount = Object.keys(doc.paragraphs || {}).length;
                const vectorClock = nodeData.vector_clock || {};
                const clockEntries = Object.entries(vectorClock)
                    .map(([node, count]) => `${node}: ${count}`)
                    .join(', ') || 'initializing...';
                
                nodeCard.innerHTML = `
                    <h4>${nodeId.toUpperCase()}</h4>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">${nodeData.address}</div>
                    <div style="font-size: 14px;">
                        <div>üìÑ Version: ${doc.version || 0}</div>
                        <div>üìù Paragraphs: ${paragraphCount}</div>
                        <div>‚úÖ Status: Healthy</div>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: #f8fafc; border-radius: 4px; border-left: 3px solid #22c55e;">
                        <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px;">üïê Vector Clock:</div>
                        <div style="font-family: monospace; font-size: 11px; color: #6b7280;">
                            {${clockEntries}}
                        </div>
                    </div>
                `;
            } else {
                nodeCard.innerHTML = `
                    <h4>${nodeId.toUpperCase()}</h4>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">${nodeData.address}</div>
                    <div style="font-size: 14px; color: #ef4444;">
                        ‚ùå Status: ${nodeData.status}
                    </div>
                `;
            }
            
            grid.appendChild(nodeCard);
        });
    }
    
    // Update vector clock display
    function updateVectorClocks(vectorClocks) {
        const display = document.getElementById('vectorClockDisplay');
        display.innerHTML = '';
        
        Object.entries(vectorClocks).forEach(([nodeId, clock]) => {
            const clockCard = document.createElement('div');
            clockCard.className = 'node-card';
            
            const clockEntries = Object.entries(clock)
                .map(([node, count]) => `${node}: ${count}`)
                .join(', ');
            
            clockCard.innerHTML = `
                <h4>${nodeId.toUpperCase()}</h4>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                    Database Node Vector Clock
                </div>
                <div style="font-family: monospace; font-size: 12px; background: #f1f5f9; padding: 8px; border-radius: 4px; margin-top: 10px;">
                    {${clockEntries || 'initializing...'}}
                </div>
                <div style="font-size: 11px; color: #9ca3af; margin-top: 5px;">
                    üí° Each number shows edit count from that node
                </div>
            `;
            
            display.appendChild(clockCard);
        });
    }
    
    // Demo control functions
    function pauseEditing() {
        isPaused = !isPaused;
        const btn = document.getElementById('pauseBtn');
        btn.innerHTML = isPaused ? '‚ñ∂Ô∏è Resume Editing' : '‚è∏Ô∏è Pause Editing';
        showMessage(isPaused ? 'Editing paused' : 'Editing resumed', 'info');
    }
    
    function simulateConflict() {
        showMessage('üî• Simulating concurrent edit conflict...', 'warning');
        
        // Show conflict card
        const conflictCard = document.getElementById('conflictCard');
        conflictCard.style.display = 'block';
        
        const conflictDisplay = document.getElementById('conflictDisplay');
        conflictDisplay.innerHTML = `
            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 20px;">
                <p style="color: #92400e; margin-bottom: 15px;">
                    Alice and Bob are editing the Introduction section simultaneously!
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid {{ user_alice.color }};">
                        <h5 style="color: {{ user_alice.color }};">Alice's Edit</h5>
                        <p style="font-size: 14px;">"The distributed database provides excellent consistency..."</p>
                        <small style="color: #6b7280;">Timestamp: ${new Date().toLocaleTimeString()}</small>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid {{ user_bob.color }};">
                        <h5 style="color: {{ user_bob.color }};">Bob's Edit</h5>
                        <p style="font-size: 14px;">"Our system ensures proper edit ordering with causal..."</p>
                        <small style="color: #6b7280;">Timestamp: ${new Date().toLocaleTimeString()}</small>
                    </div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px;">
                    <p style="color: #16a34a; font-weight: 600;">
                        ‚úÖ Causal consistency automatically resolved the conflict!
                    </p>
                    <p style="color: #15803d; font-size: 14px; margin-top: 5px;">
                        Bob's edit was applied after Alice's based on vector clock ordering
                    </p>
                    <div style="margin-top: 10px; font-size: 12px; font-family: monospace; background: white; padding: 8px; border-radius: 4px;">
                        <div style="color: #dc2626;">Before: Alice reads vector clock {node1: 5, node2: 3, node3: 2}</div>
                        <div style="color: #059669; margin-top: 2px;">After: Bob gets updated vector clock {node1: 5, node2: 4, node3: 2}</div>
                        <div style="color: #7c3aed; margin-top: 2px;">Result: Bob's edit is causally after Alice's edit</div>
                    </div>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            conflictCard.style.display = 'none';
        }, 10000);
    }
    
    function showNodeFailure() {
        showMessage('üö® Simulating Node-3 failure...', 'warning');
        
        const nodeCards = document.querySelectorAll('#nodeConsistencyGrid .node-card');
        if (nodeCards.length > 2) {
            nodeCards[2].style.border = '2px solid #ef4444';
            nodeCards[2].innerHTML += '<div style="color: #ef4444; margin-top: 10px;">‚ùå Node Failed</div>';
            
            setTimeout(() => {
                showMessage('‚úÖ Node-3 recovered! Document consistency restored.', 'success');
                loadDemoDocument();
            }, 5000);
        }
    }
    
    function refreshDemo() {
        loadDemoDocument();
        showMessage('üîÑ Status refreshed', 'info');
    }
    
    // Socket.IO event handlers
    socket.on('document_updated', function(data) {
        if (data.doc_id === demoDocumentId || data.doc_id === '{{ demo_document_id }}') {
            updateParagraph(data.para_id, data.content, data.author, data.author_color);
            addToEditHistory(data.author, data.para_id, data.content, data.timestamp, data.new_vector_clock);
            
            // Load updated document status
            setTimeout(loadDemoDocument, 500);
        }
    });
    
    socket.on('document_created', function(data) {
        if (!demoDocumentId && data.title === "üöÄ Live Collaborative Editing Demo") {
            demoDocumentId = data.doc_id;
            document.getElementById('documentTitle').textContent = data.title;
            showMessage('Demo document initialized!', 'success');
        }
    });
    
    // Initialize and start periodic updates
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìù Collaborative editor auto-demo initialized');
        
        // Load initial state
        loadDemoDocument();
        
        // Set up periodic updates
        setInterval(loadDemoDocument, 3000);
        
        // Show initial message
        showMessage('üë• Alice and Bob are editing the document in real-time!', 'info');
    });
</script>

<style>
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.live-indicator {
    color: #ef4444;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
}

.paragraph-section {
    transition: all 0.3s ease;
}

.paragraph-content {
    position: relative;
    overflow: hidden;
}

#nodeConsistencyGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

#editTimeline::-webkit-scrollbar {
    width: 6px;
}

#editTimeline::-webkit-scrollbar-track {
    background: #f1f5f9;
}

#editTimeline::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}
</style>
{% endblock %}